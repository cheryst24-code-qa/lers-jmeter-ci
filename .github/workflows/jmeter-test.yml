name: JMeter Load Test

on: 
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v4
      with:
        path: apache-jmeter-5.6.3
        key: ${{ runner.os }}-jmeter-5.6.3

    - name: Download JMeter
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      run: |
        wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
        tar -xzf apache-jmeter-5.6.3.tgz
        rm apache-jmeter-5.6.3.tgz

    - name: Set Environment Variables
      run: |
        echo "JMETER_HOME=${{ github.workspace }}/apache-jmeter-5.6.3" >> $GITHUB_ENV

    - name: Prepare Test Data (Secrets CSV)
      run: |
        mkdir -p jmeter-tests/test-data
        echo "${{ secrets.SECRETS_CSV_CONTENT }}" > jmeter-tests/test-data/secrets.csv
        if [ ! -s jmeter-tests/test-data/secrets.csv ]; then
          echo "::error::–§–∞–π–ª secrets.csv –ø—É—Å—Ç!"
          exit 1
        fi

    - name: Run JMeter Test
      working-directory: jmeter-tests
      run: |
        echo "üöÄ Starting Load Test..."
        $JMETER_HOME/bin/jmeter -n \
          -Djava.awt.headless=true \
          -Jbase_url=${{ secrets.BASE_URL }} \
          -Jport=${{ secrets.BASE_PORT }} \
          -t LERS_Auth_Test_CI.jmx \
          -l result.jtl \
          -e -o report

    # üÜï –ù–û–í–´–ô –®–ê–ì: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ Summary
    - name: Generate Test Summary
      if: always()
      working-directory: jmeter-tests
      shell: bash
      run: |
        echo "‚è≥ –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        if [ ! -f result.jtl ]; then
          echo "::error::–§–∞–π–ª result.jtl –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi

        # –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫ (–∑–∞–ø—Ä–æ—Å–æ–≤)
        # –í—ã—á–∏—Ç–∞–µ–º 1, –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Å–æ–¥–µ—Ä–∂–∏—Ç timeStamp)
        TOTAL_LINES=$(wc -l < result.jtl)
        if head -1 result.jtl | grep -q "timeStamp"; then
          TOTAL=$((TOTAL_LINES - 1))
        else
          TOTAL=$TOTAL_LINES
        fi
        
        # –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
        if [ "$TOTAL" -le 0 ]; then
          echo "::warning::–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–ø—É—Å—Ç–æ–π —Ñ–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)"
          TOTAL=0
          ERRORS=0
          ERROR_RATE="0.00"
          AVG_TIME=0
          MIN_TIME=0
          MAX_TIME=0
          THROUGHPUT="0.00"
          DURATION_SEC=0
        else
          # –ü–æ–¥—Å—á–µ—Ç –æ—à–∏–±–æ–∫ (7-—è –∫–æ–ª–æ–Ω–∫–∞ –≤ CSV JMeter: success)
          # true/false –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ 7-–º –ø–æ–ª–µ (–∏–Ω–¥–µ–∫—Å 6 –ø—Ä–∏ —Å—á–µ—Ç–µ —Å 0, –Ω–æ awk —Å—á–∏—Ç–∞–µ—Ç –ø–æ–ª—è $1, $2...)
          # –§–æ—Ä–º–∞—Ç JMeter CSV: timeStamp,elapsed,label,responseCode,responseMessage,threadName,success,...
          ERRORS=$(awk -F',' '$7 == "false" {count++} END {print count+0}' result.jtl)
          
          # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—à–∏–±–æ–∫
          ERROR_RATE=$(awk "BEGIN {printf \"%.2f\", ($ERRORS / $TOTAL) * 100}")
          
          # –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ (2-—è –∫–æ–ª–æ–Ω–∫–∞: elapsed)
          # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (NR>1) –∏ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ —á–∏—Å–µ–ª
          AVG_TIME=$(awk -F',' 'NR>1 && $2 ~ /^[0-9]+$/ {sum+=$2; count++} END {if(count>0) printf "%.0f", sum/count; else print "0"}' result.jtl)
          MIN_TIME=$(awk -F',' 'NR>1 && $2 ~ /^[0-9]+$/ {if(min=="" || $2<min){min=$2}} END {print min+0}' result.jtl)
          MAX_TIME=$(awk -F',' 'NR>1 && $2 ~ /^[0-9]+$/ {if(max=="" || $2>max){max=$2}} END {print max+0}' result.jtl)
          
          # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞ (1-—è –∫–æ–ª–æ–Ω–∫–∞: timeStamp –≤ –º—Å)
          START_TIME=$(awk -F',' 'NR==2 {print $1}' result.jtl)
          END_TIME=$(awk -F',' 'END {print $1}' result.jtl)
          
          if [ -n "$START_TIME" ] && [ -n "$END_TIME" ]; then
            DURATION_MS=$((END_TIME - START_TIME))
            DURATION_SEC=$((DURATION_MS / 1000))
            if [ "$DURATION_SEC" -eq 0 ]; then DURATION_SEC=1; fi
            THROUGHPUT=$(awk "BEGIN {printf \"%.2f\", $TOTAL / $DURATION_SEC}")
          else
            DURATION_SEC=0
            THROUGHPUT="0.00"
          fi
        fi

        # –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (–¥–ª—è –ª–æ–≥–∞)
        echo "–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: $TOTAL"
        echo "–û—à–∏–±–∫–∏: $ERRORS ($ERROR_RATE%)"
        echo "Avg: ${AVG_TIME}ms, Min: ${MIN_TIME}ms, Max: ${MAX_TIME}ms"
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ Markdown –æ—Ç—á–µ—Ç–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ Summary
        {
          echo "# üìä –û—Ç—á–µ—Ç –æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏"
          echo ""
          echo "| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |"
          echo "| :--- | :--- |"
          echo "| **–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤** | $TOTAL |"
          echo "| **–û—à–∏–±–∫–∏** | $ERRORS (**${ERROR_RATE}%**) |"
          echo "| **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è (Avg)** | ${AVG_TIME} ms |"
          echo "| **–ú–∏–Ω. –≤—Ä–µ–º—è (Min)** | ${MIN_TIME} ms |"
          echo "| **–ú–∞–∫—Å. –≤—Ä–µ–º—è (Max)** | ${MAX_TIME} ms |"
          echo "| **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å** | ${THROUGHPUT} req/sec |"
          echo "| **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | ${DURATION_SEC} —Å–µ–∫ |"
          echo ""
          echo "### –°—Ç–∞—Ç—É—Å"
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "‚ùå **–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–∞–º–∏!** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è –¥–µ—Ç–∞–ª–µ–π."
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –ø–∞–π–ø–ª–∞–π–Ω —Å—Ç–∞–ª –∫—Ä–∞—Å–Ω—ã–º
            exit 1 
          else
            echo "‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!**"
          fi
        } >> $GITHUB_STEP_SUMMARY
         
    - name: Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-report-run-${{ github.run_id }}
        path: jmeter-tests/report/
        retention-days: 7

    - name: Upload Raw Results (JTL)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-raw-data-run-${{ github.run_id }}
        path: jmeter-tests/result.jtl
        retention-days: 3