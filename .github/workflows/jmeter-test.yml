name: JMeter Load Test

on: 
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v4
      with:
        path: apache-jmeter-5.6.3
        key: ${{ runner.os }}-jmeter-5.6.3

    - name: Download JMeter
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      run: |
        wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
        tar -xzf apache-jmeter-5.6.3.tgz
        rm apache-jmeter-5.6.3.tgz

    - name: Set Environment Variables
      run: |
        echo "JMETER_HOME=${{ github.workspace }}/apache-jmeter-5.6.3" >> $GITHUB_ENV

    - name: Prepare Test Data (Secrets CSV)
      run: |
        mkdir -p jmeter-tests/test-data
        echo "${{ secrets.SECRETS_CSV_CONTENT }}" > jmeter-tests/test-data/secrets.csv
        if [ ! -s jmeter-tests/test-data/secrets.csv ]; then
          echo "::error::–§–∞–π–ª secrets.csv –ø—É—Å—Ç!"
          exit 1
        fi

    - name: Run JMeter Test
      working-directory: jmeter-tests
      run: |
        echo "üöÄ Starting Load Test..."
        $JMETER_HOME/bin/jmeter -n \
          -Djava.awt.headless=true \
          -Jbase_url=${{ secrets.BASE_URL }} \
          -Jport=${{ secrets.BASE_PORT }} \
          -t LERS_Auth_Test_CI.jmx \
          -l result.jtl \
          -e -o report

    # üÜï –ù–û–í–´–ô –®–ê–ì: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ Summary
    - name: Generate Test Summary
      if: always()
      working-directory: jmeter-tests
      run: |
        echo "‚è≥ –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞..."
        
        # –ü–∞—Ä—Å–∏–º JTL —Ñ–∞–π–ª (—Ñ–æ—Ä–º–∞—Ç CSV –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –∏–ª–∏ XML, –Ω–æ JMeter 5.x —á–∞—Å—Ç–æ –ø–∏—à–µ—Ç CSV –≤ CLI –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ)
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: JMeter –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ CLI –ø–∏—à–µ—Ç CSV –≤ .jtl, –µ—Å–ª–∏ –≤ jmeter.properties –Ω–µ –∑–∞–¥–∞–Ω–æ xml.
        # –î–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º awk –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞.
        
        TOTAL=$(wc -l < result.jtl)
        # –í—ã—á–∏—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–æ–±—ã—á–Ω–æ 1 —Å—Ç—Ä–æ–∫–∞)
        if head -1 result.jtl | grep -q "timeStamp"; then
          TOTAL=$((TOTAL - 1))
        fi

        # –ü–æ–¥—Å—á–µ—Ç –æ—à–∏–±–æ–∫ (–≥–¥–µ success = false)
        # –í CSV —Ñ–æ—Ä–º–∞—Ç–µ JMeter: timeStamp,elapsed,label,responseCode,responseMessage,threadName,success,...
        # Column 7 (index 6) –æ–±—ã—á–Ω–æ success (true/false)
        ERRORS=$(awk -F',' '$7 == "false" {count++} END {print count+0}' result.jtl)
        
        # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—à–∏–±–æ–∫
        if [ "$TOTAL" -gt 0 ]; then
          ERROR_RATE=$(awk "BEGIN {printf \"%.2f\", ($ERRORS / $TOTAL) * 100}")
        else
          ERROR_RATE="0.00"
        fi

        # –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ (Column 2 - elapsed)
        AVG_TIME=$(awk -F',' 'NR>1 && $1 !~ /timeStamp/ {sum+=$2; count++} END {if(count>0) printf "%.0f", sum/count; else print "0"}' result.jtl)
        MIN_TIME=$(awk -F',' 'NR>1 && $1 !~ /timeStamp/ {if(min==""){min=$2} if($2<min){min=$2}} END {print min}' result.jtl)
        MAX_TIME=$(awk -F',' 'NR>1 && $1 !~ /timeStamp/ {if(max==""){max=$2} if($2>max){max=$2}} END {print max}' result.jtl)
        
        # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞ (–ø–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π timestamp)
        # Column 1 - timeStamp
        START_TIME=$(awk -F',' 'NR==2 {print $1}' result.jtl)
        END_TIME=$(awk -F',' 'END {print $1}' result.jtl)
        DURATION_SEC=$(( (END_TIME - START_TIME) / 1000 ))
        if [ "$DURATION_SEC" -eq 0 ]; then DURATION_SEC=1; fi
        
        THROUGHPUT=$(awk "BEGIN {printf \"%.2f\", $TOTAL / $DURATION_SEC}")

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ Markdown
        cat >> $GITHUB_STEP_SUMMARY << EOF
# üìä –û—Ç—á–µ—Ç –æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
| :--- | :--- |
| **–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤** | $TOTAL |
| **–û—à–∏–±–∫–∏** | $ERRORS (**${ERROR_RATE}%**) |
| **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è (Avg)** | ${AVG_TIME} ms |
| **–ú–∏–Ω. –≤—Ä–µ–º—è (Min)** | ${MIN_TIME} ms |
| **–ú–∞–∫—Å. –≤—Ä–µ–º—è (Max)** | ${MAX_TIME} ms |
| **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å** | ${THROUGHPUT} req/sec |
| **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | ${DURATION_SEC} —Å–µ–∫ |

### –°—Ç–∞—Ç—É—Å
EOF

        if [ "$ERRORS" -gt 0 ]; then
          echo "‚ùå **–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–∞–º–∏!** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è –¥–µ—Ç–∞–ª–µ–π." >> $GITHUB_STEP_SUMMARY
          exit 1 # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –ø–∞–π–ø–ª–∞–π–Ω —Å—Ç–∞–ª –∫—Ä–∞—Å–Ω—ã–º, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
        else
          echo "‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-report-run-${{ github.run_id }}
        path: jmeter-tests/report/
        retention-days: 7

    - name: Upload Raw Results (JTL)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-raw-data-run-${{ github.run_id }}
        path: jmeter-tests/result.jtl
        retention-days: 3